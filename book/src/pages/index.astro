---
import BookLayout from '../layouts/BookLayout.astro';

const chapterModules = Object.values(
  import.meta.glob('./chapter-*.mdx', { eager: true })
) as Array<{ url?: string; frontmatter?: { title?: string } }>;

const base = import.meta.env.BASE_URL;
const normalizeHref = (href?: string) => {
  if (!href) return '';
  if (href.startsWith('http')) return href;
  if (href.startsWith(base)) return href;
  if (href.startsWith('/')) {
    const cleaned = href.replace(/^\/+/, '');
    const trimmed = cleaned.startsWith('book/') ? cleaned.slice(5) : cleaned;
    return `${base}${trimmed}`;
  }
  return `${base}${href}`;
};

const chapters = chapterModules
  .map((mod) => {
    const href = mod.url ?? '';
    const label = mod.frontmatter?.title ?? href;
    const match = href.match(/chapter-(\d+)/);
    const order = match ? Number(match[1]) : 999;
    return { href: normalizeHref(href), label, order };
  })
  .sort((a, b) => a.order - b.order);

const glossaryModule = Object.values(
  import.meta.glob('./glossary.mdx', { eager: true })
) as Array<{ url?: string; frontmatter?: { title?: string } }>;

if (glossaryModule[0]) {
  chapters.push({
    href: normalizeHref(glossaryModule[0].url),
    label: glossaryModule[0].frontmatter?.title ?? 'Glossary',
    order: 9999
  });
}
---
<BookLayout title="Switch Scanning Book" nextHref={chapters[0]?.href} nextLabel={chapters[0]?.label}>
  <div class="hero">
    <h1>Switch Scanning: The Interactive Book</h1>
    <p><strong>Developer + clinician-friendly guide to switch access, scanning patterns, and optimization.</strong></p>
  </div>
  <div class="card">
    <h2>Chapters</h2>
    <ul>
      {chapters.map((c) => (
        <li><a href={c.href}>{c.label}</a></li>
      ))}
    </ul>
  </div>
</BookLayout>
